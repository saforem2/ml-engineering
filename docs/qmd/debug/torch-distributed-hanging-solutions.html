<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Sam Foreman ">
<meta name="dcterms.date" content="2024-02-13">

<title>ML Engineering - Sam Foreman</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../qmd/debug/underflow_overflow.html" rel="next">
<link href="../../qmd/debug/tools.html" rel="prev">
<link href="../.././favicon.svg" rel="icon" type="image/svg+xml">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="../../site_libs/quarto-contrib/academicons-1.9.2/all.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/academicons-1.9.2/size.css" rel="stylesheet">
<script src="../../site_libs/quarto-contrib/iconify-1.0.8/iconify-icon.min.js"></script>
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-XVM2Y822Y1"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-XVM2Y822Y1', { 'anonymize_ip': true});
</script>
<link href="https://pvinis.github.io/iosevka-webfont/3.4.1/iosevka.css" rel="stylesheet">


<link rel="stylesheet" href="../../css/default.css">
<link rel="stylesheet" href="../../css/callouts.css">
<meta property="og:title" content="Sam Foreman">
<meta property="og:description" content="My ramblings about science and computers">
<meta property="og:image" content="https://github.com/saforem2/personal_site/blob/main/assets/thumbnail.png?raw=true">
<meta property="og:site_name" content="ML Engineering">
<meta name="twitter:title" content="Sam Foreman">
<meta name="twitter:description" content="My ramblings about science and computers">
<meta name="twitter:image" content="https://github.com/saforem2/personal_site/blob/main/assets/thumbnail.png?raw=true">
<meta name="twitter:creator" content="@saforem2">
<meta name="twitter:site" content="@saforem2">
<meta name="twitter:card" content="summary_large_image">
<meta name="citation_title" content="Personal Website">
<meta name="citation_author" content="Sam Foreman">
<meta name="citation_publication_date" content="2024-02-13">
<meta name="citation_cover_date" content="2024-02-13">
<meta name="citation_year" content="2024">
<meta name="citation_online_date" content="2024-02-13">
<meta name="citation_fulltext_html_url" content="https://samforeman.me">
<meta name="citation_language" content="en">
<meta name="citation_reference" content="citation_title=The climate risk &amp;amp;amp; resilience portal (ClimRR) metadata and data dictionary;,citation_author=C. Burdi;,citation_author=Wall. T Branham;,citation_publication_date=2023;,citation_cover_date=2023;,citation_year=2023;,citation_fulltext_html_url=https://dub.sh/ClimRR-Metadata;">
<meta name="citation_reference" content="citation_title=Progress on (g-2)_\mu from lattice QCD;,citation_author=Hartmut Wittig;,citation_publication_date=2023;,citation_cover_date=2023;,citation_year=2023;,citation_fulltext_html_url=https://arxiv.org/abs/2306.04165;">
<meta name="citation_reference" content="citation_title=Hybrid Monte Carlo;,citation_author=S. Duane;,citation_author=A. D. Kennedy;,citation_author=B. J. Pendleton;,citation_author=D. Roweth;,citation_publication_date=1987;,citation_cover_date=1987;,citation_year=1987;,citation_doi=10.1016/0370-2693(87)91197-X;,citation_volume=195;,citation_journal_title=Phys. Lett. B;">
<meta name="citation_reference" content="citation_title=Snowmass 2021 Computational Frontier CompF03 Topical Group Report: Machine Learning;,citation_author=Phiala Shanahan;,citation_author=others;,citation_publication_date=2022-09;,citation_cover_date=2022-09;,citation_year=2022;,citation_fulltext_html_url=https://arxiv.org/abs/2209.07559;">
<meta name="citation_reference" content="citation_title=Applications of Machine Learning to Lattice Quantum Field Theory;,citation_author=Denis Boyda;,citation_author=others;,citation_publication_date=2022-02;,citation_cover_date=2022-02;,citation_year=2022;,citation_fulltext_html_url=https://arxiv.org/abs/2202.05838;,citation_conference_title=Snowmass 2021;">
<meta name="citation_reference" content="citation_title=HMC with Normalizing Flows;,citation_author=Sam Foreman;,citation_author=Taku Izubuchi;,citation_author=Luchang Jin;,citation_author=Xiao-Yong Jin;,citation_author=James C. Osborn;,citation_author=Akio Tomiya;,citation_publication_date=2022;,citation_cover_date=2022;,citation_year=2022;,citation_fulltext_html_url=https://arxiv.org/abs/2112.01586;,citation_doi=10.22323/1.396.0073;,citation_volume=LATTICE2021;,citation_journal_title=PoS;">
<meta name="citation_reference" content="citation_title=LeapfrogLayers: A Trainable Framework for Effective Topological Sampling;,citation_author=Sam Foreman;,citation_author=Xiao-Yong Jin;,citation_author=James C. Osborn;,citation_publication_date=2022;,citation_cover_date=2022;,citation_year=2022;,citation_fulltext_html_url=https://arxiv.org/abs/2112.01582;,citation_doi=10.22323/1.396.0508;,citation_volume=LATTICE2021;,citation_journal_title=PoS;">
<meta name="citation_reference" content="citation_title=Deep Learning Hamiltonian Monte Carlo;,citation_author=Sam Foreman;,citation_author=Xiao-Yong Jin;,citation_author=James C. Osborn;,citation_publication_date=2021-05;,citation_cover_date=2021-05;,citation_year=2021;,citation_fulltext_html_url=https://arxiv.org/abs/2105.03418;,citation_conference_title=9th International Conference on Learning Representations;">
<meta name="citation_reference" content="citation_title=Energy Justice Analysis of Climate Data with ClimRR;,citation_author=Sam Foreman;,citation_publication_date=2023-08-07;,citation_cover_date=2023-08-07;,citation_year=2023;,citation_fulltext_html_url=https://saforem2.github.io/climate-analysis;,citation_language=en;">
<meta name="citation_reference" content="citation_author=Sam Foreman;,citation_publication_date=2023-08-19;,citation_cover_date=2023-08-19;,citation_year=2023;,citation_fulltext_html_url=https://saforem2.github.io/l2hmc-qcd;,citation_language=en;">
<meta name="citation_reference" content="citation_title=Deep learning hamiltonian monte carlo;,citation_author=Sam Foreman;,citation_author=Xiao-Yong Jin;,citation_author=James C. Osborn;,citation_publication_date=2021;,citation_cover_date=2021;,citation_year=2021;,citation_fulltext_html_url=https://arxiv.org/abs/2105.03418;">
<meta name="citation_reference" content="citation_title=MLMC: Machine learning monte carlo for lattice gauge theory;,citation_author=Sam Foreman;,citation_author=Xiao-Yong Jin;,citation_author=James Osborn;,citation_publication_date=00;,citation_cover_date=00;,citation_year=0;,citation_conference_title=40th international symposium on lattice field theory (lattice 2023) (batavia, IL, united states, 07/31/2023 - 08/04/2023);">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../.././favicon.svg" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">ML Engineering</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../.././qmd/posts.qmd"> 
<span class="menu-text"><span class="red-text" style="font-size: 1.0em;"><iconify-icon inline="" icon="line-md:pencil"></iconify-icon></span> Posts</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../.././qmd/slides.qmd"> 
<span class="menu-text"><span class="green-text" style="font-size: 1.0em;"><iconify-icon inline="" icon="line-md:image"></iconify-icon></span> Talks</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../.././qmd/projects.qmd"> 
<span class="menu-text"><span class="blue-text" style="font-size:1.0em;"><iconify-icon inline="" icon="line-md:computer"></iconify-icon></span> Projects</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="https://twitter.com/saforem2"> 
<span class="menu-text"><span style="font-size: 1.15em;"><iconify-icon inline="" icon="line-md:twitter"></iconify-icon></span></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://github.com/saforem2/personal_site"> 
<span class="menu-text"><span style="font-size: 1.15em;"><iconify-icon inline="" icon="line-md:github-loop"></iconify-icon></span></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
    <div class="dropdown">
      <a href="" title="" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label=""><i class="bi bi-gear"></i></a>
      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item quarto-navbar-tools-item" href="https://github.com/saforem2/personal_site/blob/main/index.qmd">
            Source Code
            </a>
          </li>
          <li>
            <a class="dropdown-item quarto-navbar-tools-item" href="https://github.com/saforem2/personal_site/issues/new/choose">
            New Issue
            </a>
          </li>
      </ul>
    </div>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">Qmd</li><li class="breadcrumb-item"><a href="../../qmd/debug/make-tiny-models-tokenizers-datasets.html">Debug</a></li><li class="breadcrumb-item"><a href="../../qmd/debug/torch-distributed-hanging-solutions.html">Sam Foreman</a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Qmd</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false">
 <span class="menu-text">Compute</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false">
 <span class="menu-text">Accelerator</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth3 ">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="false">
 <span class="menu-text">Nvidia</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth4 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../qmd/compute/accelerator/nvidia/debug.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Sam Foreman</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
 <span class="menu-text">Debug</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth2 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../qmd/debug/make-tiny-models-tokenizers-datasets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Sam Foreman</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../qmd/debug/nccl-performance-debug.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Sam Foreman</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../qmd/debug/pytorch.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Sam Foreman</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../qmd/debug/tools.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Sam Foreman</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../qmd/debug/torch-distributed-hanging-solutions.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Sam Foreman</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../qmd/debug/underflow_overflow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Sam Foreman</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="false">
 <span class="menu-text">Insights</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../qmd/insights/ai-battlefield.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Sam Foreman</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="false">
 <span class="menu-text">Network</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" aria-expanded="false">
 <span class="menu-text">Benchmarks</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-8" class="collapse list-unstyled sidebar-section depth3 ">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" aria-expanded="false">
 <span class="menu-text">Results</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-9" class="collapse list-unstyled sidebar-section depth4 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../qmd/network/benchmarks/results/disable-nvlink.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Sam Foreman</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-10" aria-expanded="false">
 <span class="menu-text">Storage</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-10" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-10" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-11" aria-expanded="false">
 <span class="menu-text">Benchmarks</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-11" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-11" class="collapse list-unstyled sidebar-section depth3 ">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-12" aria-expanded="false">
 <span class="menu-text">Results</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-12" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-12" class="collapse list-unstyled sidebar-section depth4 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../qmd/storage/benchmarks/results/hope-2023-12-20-14-37-02-331702-summary.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Sam Foreman</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-13" aria-expanded="false">
 <span class="menu-text">Training</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-13" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-13" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../qmd/training/dtype.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Sam Foreman</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../qmd/training/emulate-multi-node.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Sam Foreman</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../qmd/training/hparams.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Sam Foreman</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../qmd/training/re-train-hub-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Sam Foreman</span></a>
  </div>
</li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-14" aria-expanded="false">
 <span class="menu-text">Instabilities</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-14" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-14" class="collapse list-unstyled sidebar-section depth3 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../qmd/training/instabilities/training-loss-patterns.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Sam Foreman</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#diagnosing-hangings-and-deadlocks-in-multi-node-multi-gpu-python-programs" id="toc-diagnosing-hangings-and-deadlocks-in-multi-node-multi-gpu-python-programs" class="nav-link active" data-scroll-target="#diagnosing-hangings-and-deadlocks-in-multi-node-multi-gpu-python-programs">Diagnosing Hangings and Deadlocks in Multi-Node Multi-GPU Python Programs</a>
  <ul class="collapse">
  <li><a href="#helper-tools" id="toc-helper-tools" class="nav-link" data-scroll-target="#helper-tools">Helper tools</a></li>
  <li><a href="#approaches-to-diagnosing-multi-gpu-hanging-deadlocks" id="toc-approaches-to-diagnosing-multi-gpu-hanging-deadlocks" class="nav-link" data-scroll-target="#approaches-to-diagnosing-multi-gpu-hanging-deadlocks">Approaches to diagnosing multi-gpu hanging / deadlocks</a>
  <ul class="collapse">
  <li><a href="#py-spy" id="toc-py-spy" class="nav-link" data-scroll-target="#py-spy">py-spy</a></li>
  <li><a href="#network-level-hanging" id="toc-network-level-hanging" class="nav-link" data-scroll-target="#network-level-hanging">Network-level hanging</a></li>
  <li><a href="#isolate-problematic-gpus" id="toc-isolate-problematic-gpus" class="nav-link" data-scroll-target="#isolate-problematic-gpus">Isolate problematic GPUs</a></li>
  <li><a href="#python-trace" id="toc-python-trace" class="nav-link" data-scroll-target="#python-trace">python <code>trace</code></a></li>
  <li><a href="#good-old-print" id="toc-good-old-print" class="nav-link" data-scroll-target="#good-old-print">good old <code>print</code></a></li>
  <li><a href="#core-files" id="toc-core-files" class="nav-link" data-scroll-target="#core-files">core files</a></li>
  <li><a href="#code-loops" id="toc-code-loops" class="nav-link" data-scroll-target="#code-loops">Code loops</a></li>
  </ul></li>
  <li><a href="#hardware-specific-issues" id="toc-hardware-specific-issues" class="nav-link" data-scroll-target="#hardware-specific-issues">Hardware-specific issues</a>
  <ul class="collapse">
  <li><a href="#amdrocm-hangs-or-slow-with-iommu-enabled" id="toc-amdrocm-hangs-or-slow-with-iommu-enabled" class="nav-link" data-scroll-target="#amdrocm-hangs-or-slow-with-iommu-enabled">AMD/ROCm hangs or slow with IOMMU enabled</a></li>
  </ul></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/saforem2/personal_site/blob/main/qmd/debug/torch-distributed-hanging-solutions.qmd" class="toc-action"><i class="bi bi-github"></i>View source</a></li><li><a href="https://github.com/saforem2/personal_site/edit/main/qmd/debug/torch-distributed-hanging-solutions.qmd" class="toc-action"><i class="bi empty"></i>Edit this page</a></li><li><a href="https://github.com/saforem2/personal_site/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">Qmd</li><li class="breadcrumb-item"><a href="../../qmd/debug/make-tiny-models-tokenizers-datasets.html">Debug</a></li><li class="breadcrumb-item"><a href="../../qmd/debug/torch-distributed-hanging-solutions.html">Sam Foreman</a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Sam Foreman</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source" data-quarto-source-url="https://github.com/saforem2/personal_site/blob/main/qmd/debug/torch-distributed-hanging-solutions.qmd"><i class="bi"></i></button></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading"></div>
    <div class="quarto-title-meta-contents">
             <p><a href="https://samforeman.me">Sam Foreman </a><a href="https://orcid.org/0000-0002-9981-0876"><span class="orcid-green"><i class="ai  ai-orcid"></i></span></a> <a href="mailto:foremans@anl.gov" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading"></div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 13, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="diagnosing-hangings-and-deadlocks-in-multi-node-multi-gpu-python-programs" class="level1">
<h1>Diagnosing Hangings and Deadlocks in Multi-Node Multi-GPU Python Programs</h1>
<p>While the methodologies found in this article were developed while working with multi-node multi-gpu pytorch-based training, they, of course, can help with any multi-process multi-node Python programs.</p>
<section id="helper-tools" class="level2">
<h2 class="anchored" data-anchor-id="helper-tools">Helper tools</h2>
<p>Try to use the following script <a href="torch-distributed-gpu-test.py">torch-distributed-gpu-test.py</a> to diagnose the situation.</p>
<p>This will help primarily with discovering network-related issues. And also to quickly understand how multi-gpu communications work.</p>
<p>For code-related issues read the rest of this document.</p>
</section>
<section id="approaches-to-diagnosing-multi-gpu-hanging-deadlocks" class="level2">
<h2 class="anchored" data-anchor-id="approaches-to-diagnosing-multi-gpu-hanging-deadlocks">Approaches to diagnosing multi-gpu hanging / deadlocks</h2>
<section id="py-spy" class="level3">
<h3 class="anchored" data-anchor-id="py-spy">py-spy</h3>
<p>First do <code>pip install py-spy</code>.</p>
<p>Now you can attach to each process with:</p>
<pre><code>py-spy dump -n -p PID</code></pre>
<p>and it will tell you where the process hangs (very often it’s a nccl collective function or a <code>barrier</code>).</p>
<ul>
<li><code>PID</code> is the process id of the hanging python process.</li>
<li><code>-n</code> is useful if you want to see stack traces from python extensions written in C, C++, etc., as the program may hang in one of the extensions</li>
<li>you may need to add <code>sudo</code> before the command - for more details see <a href="https://github.com/benfred/py-spy/blob/master/README.md#when-do-you-need-to-run-as-sudo">this note</a>.</li>
</ul>
<p>If you have no <code>sudo</code> access your sysadmin might be able to perform this for you:</p>
<pre><code>sudo echo 0 &gt; /proc/sys/kernel/yama/ptrace_scope</code></pre>
<p>which will allow you running <code>py-spy</code> (and <code>strace</code>) without needing <code>sudo</code>. Beware of the possible <a href="https://wiki.ubuntu.com/SecurityTeam/Roadmap/KernelHardening#ptrace_Protection">security implications</a> - but typically if your compute node is inaccessible from the Internet it’s less likely to be a risk.</p>
<p>To make this change permanent edit <code>/etc/sysctl.d/10-ptrace.conf</code> and set:</p>
<pre><code>kernel.yama.ptrace_scope = 0</code></pre>
<p>Here is an example of <code>py-spy dump</code> python stack trace:</p>
<pre><code>Thread 835995 (active): "MainThread"
    broadcast (torch/distributed/distributed_c10d.py:1191)
    _aggregate_total_loss (deepspeed/runtime/pipe/engine.py:540)
    train_batch (deepspeed/runtime/pipe/engine.py:330)
    train_step (megatron/training.py:436)
    train (megatron/training.py:851)
    pretrain (megatron/training.py:187)
    &lt;module&gt; (pretrain_gpt.py:239)</code></pre>
<p>The very first line is where the program is stuck.</p>
<p>If the hanging happens inside a CPP extension, add <code>--native</code> <code>py-spy</code> and it’ll show the non-python code if any.</p>
<section id="multi-process-py-spy" class="level4">
<h4 class="anchored" data-anchor-id="multi-process-py-spy">multi-process py-spy</h4>
<p>Now, how do you do it for multiple processes. Doing it one-by-one is too slow. So let’s do it at once.</p>
<p>If the launch command was <code>python</code>, what you do is:</p>
<pre><code>pgrep -P $(pgrep -o python) | xargs -I {} py-spy dump --pid {}</code></pre>
<p>if <code>deepspeed</code>:</p>
<pre><code>pgrep -P $(pgrep -o deepspeed) | xargs -I {} py-spy dump --pid {}</code></pre>
<p>for <code>accelerate</code>:</p>
<pre><code>pgrep -P $(pgrep -o accelerate) | xargs -I {} py-spy dump --pid {}</code></pre>
<p>you get the idea.</p>
<p>This particular approach will only analyse the main processes and not various other sub-processes/threads spawned by these processes. So if you have 8 gpus and 8 processes, the above will generate 8 stack traces.</p>
<p>If you want all processes and their subprocesses, then you’d just run:</p>
<pre><code>pgrep -f python | xargs -I {} py-spy dump --pid {}</code></pre>
<p>(and as before replace <code>python</code> with the name of the launcher program if it’s not <code>python</code>)</p>
</section>
<section id="multi-node-py-spy-via-srun" class="level4">
<h4 class="anchored" data-anchor-id="multi-node-py-spy-via-srun">multi-node py-spy via srun</h4>
<p>What if you have multiple nodes?</p>
<p>You can of course <code>ssh</code> to each node interactively and dump the stack traces.</p>
<p>If you’re using the SLURM environment you can use <code>srun</code> to do it on all nodes for you.</p>
<p>Now in another console get the <code>SLURM_JOBID</code> (or get it from <code>salloc</code> log):</p>
<pre><code>squeue -u `whoami` -o "%.16i %9P %26j %.8T %.10M %.8l %.6D %.20S %R"</code></pre>
<p>Now use the following <code>srun</code> command after adjusting jobid with <code>SLURM_JOBID</code> from the outcome of the command above this sentence:</p>
<pre><code>srun --jobid=2180718 --gres=gpu:0 --nodes=40 --tasks-per-node=1 --output=trace-%N.out sh -c 'ps aux | grep python | egrep -v "grep|srun" | grep `whoami` | awk "{print \$2}" | xargs -I {} py-spy dump --native --pid {}' || echo "failed"</code></pre>
<p>Notes: - One must use <code>--gres=gpu:0</code> for the monitor <code>srun</code> or otherwise it will block until the main <code>srun</code> (the one running the training) exits. - Each node will generate its unique log file named <code>trace-nodename.out</code> - so this would help to identify which node(s) are problematic. You can remove <code>--output=trace-%N.out</code> if you want it all being dumped to stdout - In some SLURM versions you may also need to add <code>--overlap</code> - In some SLURM versions the jobid might not match that of reported in <code>squeue</code>, so you have to get the correct <code>SLURM_JOB_ID</code> from the logs of the job you’re trying to “attach” to - i.e.&nbsp;your <code>srun</code> job that allocated the GPUs. - Sometimes <code>bash</code> doesn’t work, but <code>sh</code> does. I think it has to do with what dot files get <code>source</code>d - You might need to also activate a custom python environment, which you can do like so:</p>
<pre><code>srun --jobid=2180718 --gres=gpu:0 --nodes=40 --tasks-per-node=1 --output=trace-%N.out sh -c 'conda activate myenvname; ps auxc | ... ' || echo "failed"</code></pre>
<p>or you can do it inside <code>~/.bashrc</code> or whatever shell’s rc file you decide to use.</p>
<p>As mentioned before if you want just the main processes you’d use this instead:</p>
<pre><code>srun --jobid=2180718 --gres=gpu:0 --nodes=40 --tasks-per-node=1 --output=trace-%N.out sh -c 'pgrep -P $(pgrep -o python) | xargs -I {} py-spy dump --pid {}' || echo "failed"</code></pre>
<p>Adjust <code>python</code> if need be as explained in the multi-gpu section above.</p>
<p>The previous longer command will deliver traces for all python processes.</p>
<p>If you’re not getting anything, start with the basic debug like:</p>
<pre><code>srun --jobid=2180718 --gres=gpu:0 --nodes=40 --tasks-per-node=1 --output=trace-%N.out sh -c 'date'</code></pre>
<p>once you know you’re talking to all the nodes, then you can progressively unravel the depth of calls, as in:</p>
<pre><code>srun --jobid=2180718 --gres=gpu:0 --nodes=40 --tasks-per-node=1 sh -c 'date'
srun --jobid=2180718 --gres=gpu:0 --nodes=40 --tasks-per-node=1 sh -c 'pgrep -o python'
srun --jobid=2180718 --gres=gpu:0 --nodes=40 --tasks-per-node=1 sh -c 'pgrep -P $(pgrep -o python) '
srun --jobid=2180718 --gres=gpu:0 --nodes=40 --tasks-per-node=1 sh -c 'pgrep -P $(pgrep -o python) | xargs -I {} py-spy dump --pid {}'</code></pre>
<p>and at each stage check that the output makes sense - e.g.&nbsp;the 2nd and 3rd call you should be getting the PIDs of the processes.</p>
</section>
<section id="multi-node-py-spy-via-pdsh" class="level4">
<h4 class="anchored" data-anchor-id="multi-node-py-spy-via-pdsh">multi-node py-spy via pdsh</h4>
<p><code>pdsh</code> seems to be a good easy tool to use to accomplish remote work on multiple nodes. Say, you’re running on 2 nodes with hostnames <code>nodename-5</code> and <code>nodename-8</code>, then you can quickly test that remote execution is working by getting the <code>date</code> on all of these hosts with just:</p>
<pre><code>$ PDSH_RCMD_TYPE=ssh pdsh -w nodename-[5,8] "date"
nodename-5: Wed Oct 25 04:32:43 UTC 2023
nodename-8: Wed Oct 25 04:32:45 UTC 2023</code></pre>
<p>footnote: <code>pdsh</code> should be available via a normal OS package installer</p>
<p>Once you tested that <code>date</code> works it’s time to move to <code>py-spy</code>.</p>
<p>To do <code>py-spy</code> on all python processes that are sub-processes, it’d be:</p>
<pre><code>PDSH_RCMD_TYPE=ssh pdsh -w nodename-[5,8] 'pgrep -P $(pgrep -o python) | xargs -I {} py-spy dump --pid {}'</code></pre>
<p>but as you’re likely to need to have the <code>~/.bashrc</code> run, you will need to clone it into <code>~/.pdshrc</code>, reduce that clone to what is needed to be run (e.g.&nbsp;modify <code>PATH</code>, <code>activate conda</code>) and then <code>source</code> it, like:</p>
<pre><code>PDSH_RCMD_TYPE=ssh pdsh -w nodename-[5,8] 'source ~/.pdshrc; pgrep -P $(pgrep -o python) | xargs -I {} py-spy dump --pid {}"'</code></pre>
<p>The reason you need a startup script is because usually <code>~/.bashrc</code> starts with:</p>
<pre><code># If not running interactively, don't do anything
case $- in
    *i*) ;;
      *) return;;
esac</code></pre>
<p>so when you run such non-interactive workflows Bash won’t process its <code>~/.bashrc</code> normally (exit early) and thus anything relying on this startup script won’t work. So you can either remove the non-interactive exiting code above or fork <code>~/.bashrc</code> into a startup file that only contains what’s needed for the remote command to succeed.</p>
<p>footnote: there is nothing special about <code>~/.pdshrc</code> - any other name would do, since you’re manually <code>source</code>ing it.</p>
<p>And if your system isn’t setup to run <code>py-spy</code> w/o <code>sudo</code> as explained a few sections up, you’d need something like this:</p>
<pre><code>PDSH_RCMD_TYPE=ssh pdsh -w nodename-[5,8] 'sudo bash -c "source ~/.pdshrc; pgrep -P $(pgrep -o python) | xargs -I {} py-spy dump --pid {}"'</code></pre>
<p>Of course, you may need to edit the <code>pgrep</code> section to narrow down which processes you want to watch.</p>
<p>Additionally, to avoid being prompted with:</p>
<pre><code>Are you sure you want to continue connecting (yes/no/[fingerprint])?</code></pre>
<p>for every new node you haven’t logged into yet, you can disable this check with:</p>
<pre><code>echo "Host *" &gt;&gt; ~/.ssh/config
echo "  StrictHostKeyChecking no" &gt;&gt; ~/.ssh/config</code></pre>
<p>Here I assume you’re on an isolated cluster so you don’t need to worry about security issues and thus bypassing such check is most likely OK.</p>
</section>
<section id="multi-node-py-spy-via-ds_ssh" class="level4">
<h4 class="anchored" data-anchor-id="multi-node-py-spy-via-ds_ssh">multi-node py-spy via ds_ssh</h4>
<p>This is yet another way, but please make sure to read the <code>pdsh</code> section above first.</p>
<p>The following notes require <code>pip install deepspeed</code>.</p>
<p>In one SLURM environment I also attempted using <code>pdsh</code> via <code>ds_ssh</code>, but somehow I wasn’t able to run <code>py-spy</code> remotely - the main issue was that remote <code>ssh</code> command wasn’t giving the same env as when I was logged in interactively via <code>ssh</code>. But if you have <code>sudo</code> access on the compute nodes then you could do:</p>
<p>First prepare <code>hostfile</code>:</p>
<pre><code>function makehostfile() {
perl -e '$slots=split /,/, $ENV{"SLURM_STEP_GPUS"};
$slots=8 if $slots==0; # workaround 8 gpu machines
@nodes = split /\n/, qx[scontrol show hostnames $ENV{"SLURM_JOB_NODELIST"}];
print map { "$_ slots=$slots\n" } @nodes'
}
makehostfile &gt; hostfile</code></pre>
<p>Adapt <code>$slots</code> to the number of gpus per node. You may have to adapt this script if your <code>scontrol</code> produces a different output.</p>
<p>Now run the <code>py-spy</code> extraction command over all participating nodes:</p>
<pre><code>ds_ssh -f hostfile "source ~/.pdshrc; ps aux | grep python | grep -v grep | grep `whoami` | awk '{print \$2}' | xargs -I {} sudo py-spy dump --pid {} "</code></pre>
<p>Notes: - Put inside <code>~/.pdshrc</code> whatever init code that you may need to run. If you don’t need any you can remove <code>source ~/.pdshrc;</code> from the command line. - If you don’t have it already <code>ds_ssh</code> is installed when you do <code>pip install deepspeed</code>. - you might need to <code>export PDSH_RCMD_TYPE=ssh</code> if you get <code>rcmd: socket: Permission denied</code> error</p>
</section>
</section>
<section id="network-level-hanging" class="level3">
<h3 class="anchored" data-anchor-id="network-level-hanging">Network-level hanging</h3>
<p>The hanging could be happening at the network level. <code>NCCL_DEBUG=INFO</code> can help here.</p>
<p>Run the script with <code>NCCL_DEBUG=INFO</code> env var and try to study the outcome for obvious errors. It will tell you which device it’s using, e.g.:</p>
<pre><code>DeepWhite:21288:21288 [0] NCCL INFO NET/Socket : Using [0]enp67s0:192.168.50.21&lt;0&gt;</code></pre>
<p>So it’s using interface <code>enp67s0</code> over <code>192.168.50.21</code></p>
<p>Is your <code>192.168.50.21</code> firewalled? or is it somehow a misconfigured network device?</p>
<p>Does it work if you use a loopback device <code>127.0.0.1</code>?</p>
<pre><code>NCCL_DEBUG=INFO NCCL_SOCKET_IFNAME=lo python -m torch.distributed.run --nproc_per_node 4 --nnodes 1 torch-distributed-gpu-test.py</code></pre>
<p>if not, see what other local network devices you have via <code>ifconfig</code> - try that instead of <code>lo</code> if any.</p>
<p>It’s currently using <code>enp67s0</code> in the above example.</p>
</section>
<section id="isolate-problematic-gpus" class="level3">
<h3 class="anchored" data-anchor-id="isolate-problematic-gpus">Isolate problematic GPUs</h3>
<p>You can also try to see if only some GPUs fail</p>
<p>For example, does it work if you use the first 2 or the last 2 gpus:</p>
<pre><code>CUDA_VISIBLE_DEVICES=0,1 python -m torch.distributed.run --nproc_per_node 2 --nnodes 1 torch-distributed-gpu-test.py</code></pre>
<p>then the 2nd pair:</p>
<pre><code>CUDA_VISIBLE_DEVICES=2,3 python -m torch.distributed.run --nproc_per_node 2 --nnodes 1 torch-distributed-gpu-test.py</code></pre>
</section>
<section id="python-trace" class="level3">
<h3 class="anchored" data-anchor-id="python-trace">python <code>trace</code></h3>
<p>Now what happens when the training doesn’t just hang, but the hanging process stops responding? e.g.&nbsp;this happens when there is a serious hardware issue. But what if it is recurrent and <code>py-spy</code> won’t help here, since it won’t be able to attach to a process that is not responding.</p>
<p>So next came the idea of tracing all calls like one does with <code>strace(1)</code>, I researched python calls tracing facilities and have discovered that python has a <code>trace</code> sub-system.</p>
<p>The following code will trace all python calls and log them to the console and into a dedicated per process log file, via a custom <code>Tee</code> module I added.</p>
<p>This then can help to understand where some processes stopped responding, since we will have the log of the last call and all the previous calls before it went unresponsive.</p>
<pre><code>$ cat train.py
[...]

def main():
    # [...]
    train()

import re
class Tee:
    """
    A helper class to tee print's output into a file.
    Usage:
    sys.stdout = Tee(filename)
    """

    def __init__(self, filename):
        self.stdout = sys.stdout
        self.file = open(filename, "a")

    def __getattr__(self, attr):
        return getattr(self.stdout, attr)

    def write(self, msg):
        self.stdout.write(msg)
        self.file.write(msg)
        self.file.flush()

    def flush(self):
        self.stdout.flush()
        self.file.flush()

if __name__ == "__main__":

    import sys
    import trace
    import socket
    import os

    # enable the trace
    if 0:
        cwd = os.path.realpath('.')
        pid = os.getpid()
        hostname = socket.gethostname()
        local_rank = int(os.environ["LOCAL_RANK"])
        trace_output_file = f"{cwd}/trace-{hostname}-{local_rank}-{pid}.txt"

        # create a Trace object, telling it what to ignore, and whether to
        # do tracing or line-counting or both.
        tracer = trace.Trace(
            ignoredirs=[sys.prefix, sys.exec_prefix],
            trace=1,
            count=1,
            timing=True,
        )

        # run the new command using the given tracer
        sys.stdout = Tee(trace_output_file)
        tracer.run('main()')
    else:
        main()
</code></pre>
<p>This code doesn’t require any special handing other than enabling the trace by changing <code>if 0</code> to <code>if 1</code>.</p>
<p>If you don’t set <code>ignoredirs</code>, this will now dump all python calls. Which means expect a lot of GBs of data logged, especially if you have hundreds of GPUs.</p>
<p>Of course, you don’t have to start tracing from <code>main</code> - if you suspect a specific are you can start tracing there instead and it’ll be much faster and less data to save.</p>
<p>I wish I could tell <code>trace</code> which packages to follow, but alas it only supports dirs to ignore, which is much more difficult to set, and thus you end up with a lot more data than needrf. But still this is a super useful tool for debugging hanging processes.</p>
<p>Also, your code will now run much much slower and the more packages you trace the slower it will become.</p>
<section id="nicertrace" class="level4">
<h4 class="anchored" data-anchor-id="nicertrace">NicerTrace</h4>
<p>As <code>Trace</code> proved to provide very limited usability when debugging a complex multi-node multi-hour run crash, I have started on working on a better version of the <code>trace</code> python module.</p>
<p>You can find it here: <a href="./NicerTrace.py">NicerTrace</a></p>
<p>I added multiple additional flags to the constructor and made the output much more useful. You fill find a full working example in that same file, just run:</p>
<pre><code>python trace/NicerTrace.py</code></pre>
<p>and you should see:</p>
<pre><code>        trace/NicerTrace.py:1 &lt;module&gt;
0:00:00 &lt;string&gt;:     1:         trace/NicerTrace.py:185 main
0:00:00 NicerTrace.py:   186:     img = Image.new("RGB", (4, 4))
        PIL.Image:2896 new
0:00:00 Image.py:  2912:     _check_size(size)
        PIL.Image:2875 _check_size
0:00:00 Image.py:  2883:     if not isinstance(size, (list, tuple)):
0:00:00 Image.py:  2886:     if len(size) != 2:
0:00:00 Image.py:  2889:     if size[0] &lt; 0 or size[1] &lt; 0:</code></pre>
<p>as you will see in the example I set:</p>
<pre><code>            packages_to_include=["PIL"],</code></pre>
<p>so it’ll trace <code>PIL</code> plus anything that is not under <code>site-packages</code>. If you need to trace another package, just add it to that list.</p>
<p>This is a very fresh work-in-progress package, so it’s evolving as we are trying to make it help us resolve a very complex crashing situation.</p>
</section>
<section id="working-with-generated-trace-files" class="level4">
<h4 class="anchored" data-anchor-id="working-with-generated-trace-files">Working with generated trace files</h4>
<p>When the per-node-rank trace files has been generated the following might be helpful to quickly analyse the situation:</p>
<ul>
<li>grep for a specific match and also print the file and line number where it was found:</li>
</ul>
<pre><code>grep -n "backward" trace*</code></pre>
<ul>
<li>show <code>tail -1</code> of all trace files followed by the name of each file:</li>
</ul>
<pre><code>find . -name "trace*" -exec sh -c 'echo "$1: $(tail -3 "$1")"' _ {} \;</code></pre>
<ul>
<li>or similar to the above, but print 5 last lines with the leading filename and some vertical white space for an easier reading:</li>
</ul>
<pre><code>find . -name "trace*" -exec sh -c 'echo; echo $1; echo "$(tail -5 "$1")"' _ {} \;</code></pre>
<ul>
<li>count how many times grep matched a given pattern in each ifle and print the matched file (in this example matching the pattern <code>backward</code>):</li>
</ul>
<pre><code>find . -name "trace*" -exec sh -c 'echo "$1: $(grep "backward" $1 | wc -l)"' _ {} \;</code></pre>
</section>
</section>
<section id="good-old-print" class="level3">
<h3 class="anchored" data-anchor-id="good-old-print">good old <code>print</code></h3>
<p>Now once you discovered where the hanging happens to further understand why this is happening, a debugger would ideally be used, but more often than not debugging multi-process (multi-node) issues can be very difficult.</p>
<p>In such situations a good old <code>print</code> works. You just need to add some debug prints before the calls where things hang, things that would help understand what lead to the deadlock. For example, some <code>barrier</code> was missing and one or a few processes skipped some code and while the rest of processes are still blocking waiting for everybody to send some data (for example in NCCL collective functions like <code>gather</code> or <code>reduce</code>).</p>
<p>You of course, want to prefix each print with the rank of the process so that you could tell which is which. For example:</p>
<pre><code>import torch.distributed as dist
print(f"{dist.get_rank()}: passed stage 0")</code></pre>
<p>What you will quickly discover is that if you have multiple GPUs these prints will be badly interleaved and you will have a hard time making sense of the debug data. So let’s fix this. We are going to override <code>print</code> with a custom version of the same, but which uses <code>flock</code> to ensure that only one process can write to stdout at the same time.</p>
<p>The helper module <code>printflock.py</code> is included <a href="../training/tools/printflock.py">here</a>. To activate it just run this at the top of the module you’re debugging:</p>
<pre><code>from printflock import printflock as print</code></pre>
<p>and now all your <code>print</code> calls in that module will magically be non-iterleaved. You can of course, just use <code>printflock</code> directly:</p>
<pre><code>from printflock import printflock
import torch.distributed as dist
printflock(f"{dist.get_rank()}: passed stage 0")</code></pre>
</section>
<section id="core-files" class="level3">
<h3 class="anchored" data-anchor-id="core-files">core files</h3>
<p>If the hanging happens inside non-python code, and <code>py-spy --native</code> isn’t enough for some reason you can make the hanging program dump a core file, which is done with one of these approaches:</p>
<pre><code>gcore &lt;pid&gt;
kill -ABRT &lt;pid&gt;</code></pre>
<p>and then you can introspect the core file as explained <a href="pytorch.md#segfaults-and-getting-a-backtrace-from-a-core-file">here</a>.</p>
<p>If you don’t get the core file dumped you need to configure your system to allow so and also specify where the core files should be saved to.</p>
<p>To ensure the file is dumped in bash run (other shells may use a different command):</p>
<pre><code>ulimit -c unlimited</code></pre>
<p>To make this persistent run:</p>
<pre><code>echo '* soft core unlimited' &gt;&gt; /etc/security/limits.conf</code></pre>
<p>On some systems like Ubuntu the core files are hijacked by <code>apport</code>, check the contents of <code>/proc/sys/kernel/core_pattern</code> to see where they are sent. You can override where they are sent with:</p>
<pre><code>sudo sysctl -w kernel.core_pattern=/tmp/core-%e.%p.%h.%t</code></pre>
<p>Change the directory if you want to, but make sure that the user the program is running under can write to that directory. To make this change permanent edit <code>/etc/sysctl.conf</code> and add <code>kernel.core_pattern=/tmp/core-%e.%p.%h.%t</code> (or modify if it’s already there).</p>
<p>footnote: see <code>man core</code> for all the different templates available</p>
<p>If on Ubuntu by default it sends core files to <code>apport</code>, which may save the core to <code>/var/lib/apport/coredump</code> or <code>/var/crash</code>. But you can change it explained above.</p>
<p>A quick way to test if your setup can generate a core file is:</p>
<pre><code>sleep 10 &amp;
killall -SIGSEGV sleep</code></pre>
<p>Normally <code>SIGSEGV</code> isn’t recommended for a real situation of diagnosing a hanging program, because <code>SIGSEGV</code> is likely to launch a sighandler, but for this test it’s good enough.</p>
</section>
<section id="code-loops" class="level3">
<h3 class="anchored" data-anchor-id="code-loops">Code loops</h3>
<p>Code loops can be tricky to debug in hanging scenarios. If you have code like the following:</p>
<pre><code>for i, d in enumerate(data):
    some_hanging_call(d)</code></pre>
<p>it’s possible that one process hangs in the first iteration, and another process in the second iteration, which makes things very confusing. But the stack trace won’t give such indication, as the line numbers would be the same, even though the processes aren’t in the same place code progression-wise.</p>
<p>In such situations unroll the loop to be:</p>
<pre><code>d_iter = iter(data)
some_hanging_call(next(d_iter)
some_hanging_call(next(d_iter)</code></pre>
<p>and now when you run <code>py-spy</code> the line numbers will be correct. The processes hanging in the first iteration will report the first <code>some_hanging_call</code> and those in the second iteration in the second call - as each now has its own line.</p>
</section>
</section>
<section id="hardware-specific-issues" class="level2">
<h2 class="anchored" data-anchor-id="hardware-specific-issues">Hardware-specific issues</h2>
<section id="amdrocm-hangs-or-slow-with-iommu-enabled" class="level3">
<h3 class="anchored" data-anchor-id="amdrocm-hangs-or-slow-with-iommu-enabled">AMD/ROCm hangs or slow with IOMMU enabled</h3>
<p>AMD Instinct users may need to either <a href="https://github.com/stas00/toolbox/issues/1#issuecomment-1076830400">Disable IOMMU</a> or set it to:</p>
<pre><code>GRUB_CMDLINE_LINUX_DEFAULT="iommu=soft"</code></pre>
<p>in <code>/etc/default/grub</code> (the grub config file could be elsewhere depending on the OS).</p>
<p>Disabling is <code>GRUB_CMDLINE_LINUX="amd_iommu=off"</code></p>


</section>
</section>
</section>

<a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{foreman2024,
  author = {Foreman, Sam},
  title = {Personal {Website}},
  date = {2024-02-13},
  url = {https://samforeman.me},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-foreman2024" class="csl-entry quarto-appendix-citeas" role="listitem">
Foreman, Sam. 2024. <span>“Personal Website.”</span> February 13, 2024.
<a href="https://samforeman.me">https://samforeman.me</a>.
</div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = true;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../qmd/debug/tools.html" class="pagination-link  aria-label=" sam="" foreman"="">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Sam Foreman</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../qmd/debug/underflow_overflow.html" class="pagination-link" aria-label="Sam Foreman">
        <span class="nav-page-text">Sam Foreman</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Copyright 2023, Sam Foreman</p>
</div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="https://samforeman.me">
<p><span style="font-size: 1.25em;">{{&lt; fa solid home &gt;}}</span></p>
</a>
  </li>  
    <li class="nav-item">
    <a class="nav-link" href="https://github.com/saforem2">
<p><span style="font-size: 1.25em;">{{&lt; fa brands github &gt;}}</span></p>
</a>
  </li>  
    <li class="nav-item">
    <a class="nav-link" href="https://twitter.com/saforem2">
<p><span style="font-size: 1.25em;">{{&lt; fa brands twitter &gt;}}</span></p>
</a>
  </li>  
    <li class="nav-item">
    <a class="nav-link" href="mailto:///foremans@anl.gov">
<p><span style="font-size: 1.25em;">{{&lt; fa regular paper-plane &gt;}}</span></p>
</a>
  </li>  
    <li class="nav-item">
    <a class="nav-link" href="https://scholar.google.com/citations?user=vV_1zDwAAAAJ&amp;hl=en">
<p><span style="font-size: 1.25em;"><i class="ai  ai-google-scholar"></i></span></p>
</a>
  </li>  
    <li class="nav-item">
    <a class="nav-link" href="https://orcid.org/0000-0002-9981-0876">
<p><span style="font-size: 1.25em;"><i class="ai  ai-orcid"></i></span></p>
</a>
  </li>  
    <li class="nav-item">
    <a class="nav-link" href="https://www.last.fm/user/saforem2">
<p><span style="font-size: 1.25em;">{{&lt; fa brands lastfm &gt;}}</span></p>
</a>
  </li>  
    <li class="nav-item">
    <a class="nav-link" href="https://open.spotify.com/user/saforem2">
<p><span style="font-size: 1.25em;">{{&lt; fa brands spotify &gt;}}</span></p>
</a>
  </li>  
    <li class="nav-item">
    <a class="nav-link" href="https://www.instagram.com/saforem2">
<p><span style="font-size: 1.25em;">{{&lt; fa brands instagram &gt;}}</span></p>
</a>
  </li>  
    <li class="nav-item">
    <a class="nav-link" href="https://linkedin.com/in/saforem2">
<p><span style="font-size: 1.25em;">{{&lt; fa brands linkedin &gt;}}</span></p>
</a>
  </li>  
</ul>
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/saforem2/personal_site/blob/main/qmd/debug/torch-distributed-hanging-solutions.qmd" class="toc-action"><i class="bi bi-github"></i>View source</a></li><li><a href="https://github.com/saforem2/personal_site/edit/main/qmd/debug/torch-distributed-hanging-solutions.qmd" class="toc-action"><i class="bi empty"></i>Edit this page</a></li><li><a href="https://github.com/saforem2/personal_site/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
<p><a href="https://samforeman.me">samforeman.me</a></p>
</div>
  </div>
</footer>




</body></html>